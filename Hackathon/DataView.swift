import Foundation
import SwiftUI

var thisNewString = "\"ht=\"180\" src=\"https://images.heb.com/is/image/HEBGrocery/prd-small/003992004.jpg\" class=\"sc-n1kvju-0 gLQhnz\" alt=\"H-E-B Chopped Ham, 12 oz\" "
+ "loading=\"lazy\"/></picture></div><div data-qe-id=\"productCardDetails\" class=\"sc-1br15vt-2 ctBNuH\"><div data-qe-id=\"productPrice\" "
+ "class=\"sc-fw8bou-2 fgHkQe\"><span class=\"sc-fw8bou-0 gzoZqg\">$3.07 each</span><span class=\"sc-fw8bou-1 ldEYnZ\">(<!-- -->$0.26<!-- --> "
+ "/ <!-- -->oz<!-- -->)</span></div><div data-qe-id=\"productTitle\" class=\"sc-cix52n-0 gwYmpV\">"
+ "<span title=\"H-E-B Chopped Ham, 12 oz\" class=\"sc-cix52n-1 iYhKIn\">H-E-B Chopped Ham, 12 oz</span>"
+ "</div></div></span></a><div data-qe-id=\"buttonContainer\" class=\"sc-1br15vt-8 iHUKht\"><div>"
+ "<div class=\"sc-154c4g8-1 eFrAPi\"><div class=\"sc-154c4g8-0 kQxVln\"><button type=\"button\" data-qe-id=\"addToCart\" "
+ "aria-label=\"Add to cart\" class=\"sc-1xszbkg-0 ffMMuT sc-154c4g8-5 eAYXAL\"><span class=\"sc-rgqbsd-0 eQlRCI\">"
+ "<div class=\"sc-154c4g8-6 kJJmFe=\"button\" data-qe-id=\"addToList\" variant=\"link\" class=\"sc-1xszbkg-0 sc-oywscn-3 "
+ "bEDODQ gBUoEw sc-1br15vt-10 gRPaNz\"><span class=\"sc-rgqbsd-0 eQlRCI\">Add to list</span></button></div></div>"
+ "</div><div class=\"sc-1br15vt-0 ksHYbe sc-1i1qhi9-0 bqfYYk\"><div data-qe-id=\"productCard\" class=\"sc-1br15vt-1 cKZCpg\">"
+ "<a class=\"sc-1xszbkg-0 sc-ss7bh7-0 tvZSR dDtdYG sc-ss7bh7-1 hWgUgH sc-1i1qhi9-0 bqfYYk\" "
+ "href=\"/product-detail/spam-less-salt-luncheon-loaf-12-oz/117989\" aria-label=\"Spam Less Salt Luncheon Loaf, 12 oz,  "
+ "$3.69 each.\"><span class=\"sc-rgqbsd-0 eQlRCI\"><div class=\"sc-1br15vt-7 heWSNh\"><picture class=\"sc-11m65cv-0 "
+ "sc-1br15vt-4 ekFckH fWeQMX\"><img width=\"180\" height=\"180\" src=\"https://images.heb.com/is/image/HEBGrocery/prd-small/000117989.jpg\" "
+ "class=\"sc-n1kvju-0 gLQhnz\" alt=\"Spam Less Salt Luncheon Loaf, 12 oz\" loading=\"lazy\"/></picture></div><div data-qe-id=\"productCardDetails\" class=\"sc-1br15vt-2 ctBNuH\"><div data-qe-id=\"productPrice\" class=\"sc-fw8bou-2 fgHkQe\"><span class=\"sc-fw8bou-0 gzoZqg\">$3.69 each</span><span class=\"sc-fw8bou-1 ldEYnZ\">(<!-- -->$0.31<!-- --> / <!-- -->oz<!-- -->)</span></div><div data-qe-id=\"productTitle\" class=\"sc-cix52n-0 gwYmpV\"><span title=\"Spam Less Salt Luncheon Loaf, 12 oz\" class=\"sc-cix52n-1 iYhKIn\">Spam Less Salt Luncheon Loaf, 12 oz</span></div></div></span></a><div data-qe-id=\"buttonContainer\" class=\"sc-1br15vt-8 iHUKht\"><div><div class=\"sc-154c4g8-1 eFrAPi\"><div class=\"sc-154c4g8-0 kQxVln\"><button type=\"button\" data-qe-id=\"addToCart\" aria-label=\"Add to cart\" class=\"sc-1xszbkg-0 ffMMuT sc-154c4g8-5 eAYXAL\"><span class=\"sc-rgqbsd-0 eQlRCI\"><div class=\"sc-154c4g8-6 kJJmFX\">Add to cart</div></span></button></div></div></div><button type=\"button\" data-qe-id=\"addToList\" variant=\"link\" class=\"sc-1xszbkg-0 sc-oywscn-3 bEDODQ gBUoEw sc-1br15vt-10 gRPaNz\">5 25.1046 6.39543 26 7.5 26H17.5C18.6046 26 19.5 25.1046 19.5 24V22H53.5Z\" fill=\"black\" fill-opacity=\"0.01\"></path></g><path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M1.50007 26.0001L1.50007 4.00007C1.50003 2.3432 2.8432 1.00003 4.50007 1.00007H68.5725C70.2071 1.00007 71.1514 2.85448 70.19 4.17641L65.3556 10.8237C64.81544 25.6562 1 26.5\" stroke=\"white\" stroke-linecap=\"square\" stroke-linejoin=\"round\"></path><path d=\"M14.2402 9.20898C13.6895 9.20898 13.2598 9.43555 12.9512 9.88867C12.6426 10.3379 12.4883 10.959 12.4883 11.752C12.4883 13.4004 13.1152 14.2246 14.3691 14.2246C14.748 14 13.9609 16.1836 13.834 16.543 13.6855V1086 55.6309 10.9082 55.6309 11.6816V16H53.3398Z\" fill=\"#414142\"></path></g><defs><filter id=\"flag_coupon_svg__filter0_d\" x=\"-4.5\" y=\"-5\" width=\"76.0761\" height=\"45\" filterUnits=\"userSpaceOnUse\" color-interpolation-filters=\"sRGB\"><feFlood flood-opacity=\"0\" result=\"BackgroundImageFix\"></feFlood><feColorMatrix in=\"SourceAlpha\" type=\"matrix\" values=\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0\"></feColorMatrix><feOffset dx=\"2\" dy=\"2\"></feOffset><feGaussianBlur stdDeviation=\"6\"></feGaussianBlur><feColorMatrix type=\"matrix\" values=\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.15 0\"></feColorMatrix><feBlend mode=\"normal\" in2=\"BackgroundImageFix\" result=\"effect1_dropShadow\"></feBlend><feBlend mode=\"normal\" in=\"SourceGraphic\" in2=\"effect1_dropShadow\" result=\"shape\"></feBlend></filter><linearGradient id=\"flag_coupon_svg__paint0_linear\" x1=\"8.5\" y1=\"23\" x2=\"8.5\" y2=\"29\" gradientUnits=\"userSpaceOnUse\"><stop stop-color=\"#CFA300\"></stop><stop offset=\"1\" stop-color=\"#FCD131\"></stop></linearGradient><clipPath id=\"flag_coupon_svg__clip0\"><rect width=\"71\" height=\"38\" fill=\"white\"></rect></clipPath></defs></svg></div><picture class=\"sc-11m65cv-0 sc-1br15vt-4 ekFckH fWeQMX\"><img width=\"180\" height=\"180\" src=\"https://images.heb.com/is/image/HEBGrocery/prd-small/003992003.jpg\" class=\"sc-n1kvju-0 gLQhnz\" alt=\"H-E-B Reduced Sodium Chopped Ham, 12 oz\" loading=\"lazy\"/></picture></div><div data-qe-id=\"productCardDetails\" class=\"sc-1br15vt-2 ctBNuH\"><div data-qe-id=\"productPrice\" class=\"sc-fw8bou-2 fgHkQe\"><span class=\"sc-fw8bou-0 gzoZqg\">$3.07 each</span><span class=\"sc-fw8bou-1 ldEYnZ\">(<!-- -->$0.26<!-- --> / <!-- -->oz<!-- -->)</span></div><div data-qe-id=\"productTitle\" class=\"sc-cix52n-0 gwYmpV\"><span title=\"H-E-B Reduced Sodium Chopped Ham, 12 oz\" class=\"sc-cix52n-1 iYhKIn\">H-E-B Reduced Sodium Chopped Ham, 12 oz</span></div></div></span></a><div data-qe-id=\"buttonContainer\" class=\"sc-1br15vt-8 iHUKht\"><div><div class=\"sc-154c4g8-1 eFrAPi\"><div class=\"sc-154c4g8-0 kQxVln\"><button type=\"button\" data-qe-id=\"addToCart\" aria-label=\"Add to cart\" class=\"sc-1xszbkg-0 ffMMuT sc-154c4g8-5 eAYXAL\"><span class=\"sc-rgqbsd-0 eQlRCI\"><div class=\"sc-154c4g8-6 kJJmFX\">Add to cart</div></span></button></div></div></div><button type=\"button\" data-qe-id=\"addToList\" variant=\"link\" class=\"sc-1xszbkg-0 sc-oywscn-3 bEDODQ gBUoEw sc-1br15vt-10 gRPaNz\"><span class=\"sc-rgqbsd-0 eQlRCI\">Add to list</span></button></div></div></div><div class=\"sc-1br15vt-0 ksHYbe sc-1i1qhi9-0 bqfYYk\"><div data-qe-id=\"productCard\" class=\"sc-1br15vt-1 cKZCpg\"><a class=\"sc-1xszbkg-0 sc-ss7bh7-0 tvZSR dDtdYG sc-ss7bh7-1 hWgUgH sc-1i1qhi9-0 bqfYYk\" href=\"/product-detail/spam-lite-luncheon-loaf-12-oz/118010\" aria-label=\"Spam Lite Luncheon Loaf, 12 oz,  $3.69 each.\"><span class=\"sc-rgqbsd-0 eQlRCI\"><div class=\"sc-1br15vt-7 heWSNh\"><picture class=\"sc-11m65cv-0 sc-1br15vt-4 ekFckH fWeQMX\"><img width=\"180\" height=\"180\" src=\"https://images.heb.com/is/image/HEBGrocery/prd-small/000118010.jpg\" class=\"sc-n1kvju-0 gLQhnz\" alt=\"Spam Lite Luncheon Loaf, 12 oz\" loading=\"lazy\"/></picture></div><div data-qe-id=\"productCardDetails\" class=\"sc-1br15vt-2 ctBNuH\"><div data-qe-id=\"productPrice\" class=\"sc-fw8bou-2 fgHkQe\"><span class=\"sc-fw8bou-0 gzoZqg\">$3.69 each</span><span class=\"sc-fw8bou-1 ldEYnZ\">(<!-- -->$0.31<!-- --> / <!-- -->oz<!-- -->)</span></div><div data-qe-id=\"productTitle\" class=\"sc-cix52n-0 gwYmpV\"><span title=\"Spam Lite Luncheon Loaf, 12 oz\" class=\"sc-cix52n-1 iYhKIn\">Spam Lite Luncheon Loaf, 12 oz</span></div></div></span></a><div data-qe-id=\"buttonContainer\" class=\"sc-1br15vt-8 iHUKht\"><div><div class=\"sc-154c4g8-1 eFrAPi\"><div class=\"sc-154c4g8-0 kQxVln\"><button type=\"button\" data-qe-id=\"addToCart\" aria-label=\"Add to cart\" class=\"sc-1xszbkg-0 ffMMuT sc-154c4g8-5 eAYXAL\"><span class=\"sc-rgqbsd-0 eQlRCI\"><div class=\"sc-154c4g8-6 kJJmFX\">Add to cart</div></span></button></div></div></div><button type=\"button\" data-qe-id=\"addToList\" variant=\"link\" class=\"sc-1xszbkg-0 sc-oywscn-3 bEDODQ gBUoEw sc-1br15vt-10 gRPaNz\"><span class=\"sc-rgqbsd-0 eQlRCI\">Add to list</span></button></div></div></div><div class=\"sc-1br15vt-0 ksHYbe sc-1i1qhi9-0 bqfYYk\"><div data-qe-id=\"productCard\" class=\"sc-1br15vt-1 cKZCpg\"><a class=\"sc-1xszbkg-0 sc-ss7bh7-0 tvZSR dDtdYG sc-ss7bh7-1 hWgUgH sc-1i1qhi9-0 bqfYYk\" href=\"/product-detail/h-e-b-chopped-ham-2-ct/5078511\" aria-label=\"H-E-B Chopped Ham, 2 ct,  $6.06 each.\"><span class=\"sc-rgqbsd-0 eQlRCI\"><div class=\"sc-1br15vt-7 heWSNh\"><picture class=\"sc-11m65cv-0 sc-1br15vt-4 ekFckH fWeQMX\"><img width=\"180\" height=\"180\" src=\"https://images.heb.com/is/image/HEBGrocery/prd-small/005078511.jpg\" class=\"sc-n1kvju-0 gLQhnz\" alt=\"H-E-B Chopped Ham, 2 ct\" loading=\"lazy\"/></picture></div><div data-qe-id=\"productCardDetails\" class=\"sc-1br15vt-2 ctBNuH\"><div data-qe-id=\"productPrice\" class=\"sc-fw8bou-2 fgHkQe\"><span class=\"sc-fw8bou-0 gzoZqg\">$6.06 each</span><span class=\"sc-fw8bou-1 ldEYnZ\">(<!-- -->$0.25<!-- --> / <!-- -->oz<!-- -->)</span></div><div data-qe-id=\"productTitle\" class=\"sc-cix52n-0 gwYmpV\"><span title=\"H-E-B Chopped Ham, 2 ct\" class=\"sc-cix52n-1 iYhKIn\">H-E-B Chopped Ham, 2 ct</span></div></div></span></a><div data-qe-id=\"buttonContainer\" class=\"sc-1br15vt-8 iHUKht\"><div><div class=\"sc-154c4g8-1 eFrAPi\"><div class=\"sc-154c4g8-0 kQxVln\"><button type=\"button\" data-qe-id=\"addToCart\" aria-label=\"Add to cart\" class=\"sc-1xszbkg-0 ffMMuT sc-154c4g8-5 eAYXAL\"><span class=\"sc-rgqbsd-0 eQlRCI\"><div class=\"sc-154c4g8-6 kJJmFX\">Add to cart</div></span></button></div></div></div><button type=\"button\" data-qe-id=\"addToList\" variant=\"link\" class=\"sc-1xszbkg-0 sc-oywscn-3 bEDODQ gBUoEw sc-1br15vt-10 gRPaNz\"><span class=\"sc-rgqbsd-0 eQlRCI\">Add to list</span></button></div></div></div><div class=\"sc-1br15vt-0 ksHYbe sc-1i1qhi9-0 bqfYYk\"><div data-qe-id=\"productCard\" class=\"sc-1br15vt-1 cKZCpg\"><a class=\"sc-1xszbkg-0 sc-ss7bh7-0 tvZSR dDtdYG sc-ss7bh7-1 hWgUgH sc-1i1qhi9-0 bqfYYk\" href=\"/product-detail/spam-oven-roasted-turkey-12-oz/288944\" aria-label=\"Spam Oven Roasted Turkey, 12 oz,  $3.69 each.\"><span class=\"sc-rgqbsd-0 eQlRCI\"><div class=\"sc-1br15vt-7 heWSNh\"><picture class=\"sc-11m65cv-0 sc-1br15vt-4 ekFckH fWeQMX\"><img width=\"180\" height=\"180\" src=\"https://images.heb.com/is/image/HEBGrocery/prd-small/000288944.jpg\" class=\"sc-n1kvju-0 gLQhnz\" alt=\"Spam Oven Roasted Turkey, 12 oz\" loading=\"lazy\"/></picture></div><div data-qe-id=\"productCardDetails\" class=\"sc-1br15vt-2 ctBNuH\"><div data-qe-id=\"productPrice\" class=\"sc-fw8bou-2 fgHkQe\"><span class=\"sc-fw8bou-0 gzoZqg\">$3.69 each</span><span class=\"sc-fw8bou-1 ldEYnZ\">(<!-- -->$0.31<!bkg\""

struct DataView: View {
    var sText: String
    @State private var myValue: String = ""
    @State var thisList: [ItemView] = getProducts(thisString: thisNewString)//myString ?? "")
    
    @State var thisPrice: Float = 10.00
    @State var thisName: String = "ItemName"
    
    var body: some View {
        VStack{
            ItemView(Price: thisPrice, Item: thisName, PictureURL: "120912")
            //thisList[thisList.count-1]
            Text(myValue).onAppear {
                startLoad(searchText: sText, userCompletionHandler: { myString, error in
                    if myString != nil{
                        myValue = myString ?? "loading..."
                        print(thisList.count)
                        //thisList = getProducts(thisString: thisNewString)//myString ?? "")
                        //thisPrice = thisList[1].Price
                        //thisName = thisList[1].Item
                    }
                })
            }
        }
    }
    
}

func startLoad(searchText: String, userCompletionHandler: @escaping (String?, Error?) -> Void) {
    let url = URL(string: "https://www.heb.com/search/?q=spam")!
    let task = URLSession.shared.dataTask(with: url) { data, response, error in
        if let error = error {
            return
        }
        guard let httpResponse = response as? HTTPURLResponse,
            (200...299).contains(httpResponse.statusCode) else {
            return
        }
        if let mimeType = httpResponse.mimeType, mimeType == "text/html",
            let data = data,
            let string = String(data: data, encoding: .utf8) {
            //print(string)
            userCompletionHandler(string, nil)
        }
    }
    task.resume()
}

func getProducts(thisString: String) -> [ItemView]{
    var thisList: [ItemView] = []
    let scanner = Scanner(string: thisString)
    while !scanner.isAtEnd {
        var scannedString: String?
        scannedString = scanner.scanUpToString("small/")
        //print(scannedString)
        assignProducts(thisString: scannedString ?? "hi")
        scannedString = scanner.scanString("small/")
    }
    return thisList
}

func assignProducts(thisString: String) -> ItemView{
    let scanner = Scanner(string: thisString)
    var scannedString: String
    scannedString = scanner.scanUpToString(".") ?? ""
    _ = scanner.scanString(".")
    _ = scanner.scanUpToString("alt=\"")
    _ = scanner.scanString("alt=\"")
    
    var scannedString2: String
    scannedString2 = scanner.scanUpToString(",") ?? ""
    _ = scanner.scanString(",")
    
    var scannedString3: String
    scannedString3 = scanner.scanUpToString(" each") ?? " "
    var indeX = scannedString3.lastIndex(of: "$") ?? scannedString3.startIndex
    var price: String = String(scannedString3[indeX..<scannedString3.endIndex])
    var newStartIndex = price.startIndex
    newStartIndex = price.index(newStartIndex, offsetBy: 1)
    let newEndIndex = price.endIndex
    price = String(price[newStartIndex..<newEndIndex])
    
    if((Float(price) ?? 0.00) != 0.00){
        return ItemView(Price: Float(price) ?? 0.00, Item: scannedString2, PictureURL: scannedString)
    }
    return ItemView(Price: Float(price) ?? 0.00, Item: scannedString2, PictureURL: scannedString)
}
